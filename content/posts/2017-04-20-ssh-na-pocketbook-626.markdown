---
published: true
layout: post
title: Получение доступа по SSH к Pocketbook 626+
date: 2017-04-20 10:18:19 +0500
updated: false
tags: [pocketbook, hack, linux]
keywords: [pocketbook, hack, linux]
description: "Описание процесса получения доступа к электронной книге и установки демона SSH. Все действия выполняются в OS Linux"
---

### Напильник на изготовку ###

Читалка [Pocketbook 626+][1] обладает довольно-таки неплохими техническими характеристиками для своей цены.
К сожалению, ничто не совершенно, и в некоторых случаях ПО, предоставляемое производителем этой электронной книги, оставляет желать лучшего.
Хорошей новостью можно считать то, что в качестве ОС этой читалки используется Linux, а это означает, что пользова&#173;тель может самостоятельно 
исправить некоторые недочёты ванильной прошивки. Для начала организуем доступ по SSH.

### Получение шелла ###

Чтобы получить простой шелл на Pocketbook 626+, можно использовать [приложение][2], написанное пользователем [review на mobileread.com][3]. Подключите читалку к ПК и скопируйте это приложение в каталог **applications** встроенной памяти. После этого, откройте скопированный файл в вашем любимом текстовом редакторе. Как вы можете заметить, это простой сценарий:
```bash
    #!/bin/sh

    # connect only to network if we're not already connected
    mypid="$(ps |grep netagent|grep connect)"
    if [[ "$mypid" == "" ]]; then 
      /ebrmain/bin/netagent connect
    fi

    myip=192.168.1.2

    #create backpipe if it doesn't exist
    if ls -l /tmp/|grep backpipe |grep ^p; then
      echo "debug: backpipe exist."
    else
      mknod /tmp/backpipe p
    fi

    # the heart...
    nc $myip 9999 0</tmp/backpipe|/bin/sh -i 2>&1 |tee -a /tmp/backpipe;
    
    
    # disconnect, if started by us.
    if [[ "$mypid" == "" ]]; then 
      /ebrmain/bin/netagent disconnect
    fi
```
Вам необходимо изменить переменную **myip**, прописав там IP-адрес вашего ПК. Дело в том, что **netcat**, входящая в состав прошивки Pocketbook 626+, не может запускаться в режиме прослушивания порта, поэтому читалка должна сама устанавливать соединение. Разумеется, читалка и ПК должны находиться в пределах одной локальной сети.

Сохраните файл, отмонтируйте читалку. На вашем ПК запустите:
```bash
    nc -l 9999
```
После этого запустите приложение **rsh** на вашей электронной книге. Соединение Wi-Fi будет установлено автоматически. Теперь можно пользоваться открытой вами ранее консолью для доступа к командной строке читалки.

### Полноценный SSH и SFTP ###

Для получения почти полноценного доступа к читалке RSH мало. В частности, такое подключение не позволит удобно передать файлы, да и передача незашифрованного трафика небезопасна. К счастью, есть собранная пользователем **rkomar** на [форуме mobiread.com][5] версия sshd, которую можно запускать от имени обычного пользователя. Для Pocketbook 626+ нужно [скачать][6] версию **pbsshd 1.3_fwv5**. Распакуйте архив, подключите читалку к ПК и скопируйте содержимое в каталог **applications** встроенной памяти. 

После этого отредактируйте конфигурацию, которая находится в _applications/pb_sshd/etc/ssh/sshd_config_. Привожу пример своей конфигурации:
```
    Port 10022
    Protocol 2
    AllowUsers reader sreader
    UsePrivilegeSeparation no
    PermitRootLogin no
    PermitEmptyPasswords yes
    RSAAuthentication yes
    PubkeyAuthentication yes
    StrictModes no
    AuthorizedKeysFile /mnt/ext1/applications/pb_sshd/etc/ssh/authorized_keys2
    Subsystem sftp /mnt/ext1/applications/pb_sshd/usr/libexec/sftp-server 
```
Я изменил в конфигурации по умолчанию только номер порта, который слушает демон sshd. Значение этого параметра не должно быть 1024 или меньше, так как порты от 0 до 1024 - привилегированные и открывать их обычный пользователь не может.

Следующий шаг - создать пару ключей RSA, с помощью которых вы будете устанавливать SSH-соединение. Как это сделать - [ищите в сети][7]. После создания пары ключей публичный ключ необходимо разместить по адресу _applications/pb\_sshd/etc/ssh/authorized\_keys2_. После этого отмонтируйте читалку и запустите приложение **sshd_start**.

Протестируйте подключение при помощи команды:
```bash
    ssh reader@192.168.10.57 -p 10022 "sh"
```
Не забудьте указать IP-адрес, который получило именно ваше устройство. Узнать его можно, запустив "Настройки" -> "Wi-Fi" и нажав на SSID сети, к которой в данный момент подключена ваша читалка.

> После подключения вы не увидите приглашения командной строки. Это нормально и связано с ограничениями, накладываемыми на демон sshd при запуске с правами обычного пользователя. Попробуйте ввести пару команд, например, ls.

Для того, чтобы не вводить каждый раз при подключении имя пользователя, адрес и прочие параметры, добавьте в вашу конфигурацию ssh (~/.ssh/config) следующее (укажите IP-адрес вашей читалки):
```
    Host pocketbook 
     HostName 192.168.10.57 
     Port 10022
     User reader 
```
Это позволит сократить вышеуказанную команду до
```bash
    ssh pocketbook "sh"
```
Если ваше подключение работает нормально, поздравляю! Теперь вы можете подключаться к консоли читалки, а также передавать файлы. Можно ис&#173;поль&#173;зо&#173;вать **rsync**, а если ваш файловый менеджер поддерживает подключения SFTP, используйте адрес:
```
    sftp://pocketbook
```
После завершения сеанса запустите на читалке приложение **sshd_stop**.

#### Послесловие ####

Эта статья - первая из планируемого цикла, посвящённого модификациям и расширению возможностей Pocketbook 626+. В дальнейшем здесь должны появиться ссылки на следующие статьи.

[1]: http://www.pocketbook-int.com/ru/products/pocketbook-626-plus#specifications "Технические характеристики"
[2]: http://trefmanic.me/files/rsh.app "Приложение rsh для Pocketbook 626+"
[3]: https://www.mobileread.com/forums/showthread.php?t=116350 "Ветка на форуме Mobileread"
[5]: https://www.mobileread.com/forums/showthread.php?t=159636 "SSHD, собранный для Pocketbook на форуме Mobiread"
[6]: http://trefmanic.me/files/pbsshd_1.3_fwv5.zip "Архив с версией для прошивки v5 и выше"
[7]: https://www.google.ru/search?q=Создать+ключи+rsa "Создание пары ключей RSA"
